<?php

if (!function_exists('minimal_lite_ajax_pagination')):
    /**
     * Outputs the required structure for ajax loading posts on scroll and click
     *
     * @since 1.0.0
     * @param $type string Ajax Load Type
     */
    function minimal_lite_ajax_pagination($type)
{
        if ($GLOBALS['wp_query']->max_num_pages > 1) {
            ?>
<div class="load-more-posts" data-load-type="<?php echo esc_attr($type); ?>">
    <a href="#" class="btn btn-load-more secondary-font">
        <span class="ajax-loader"></span>
        <?php _e('More Businesses', 'minimal-lite')?>
    </a>
</div>
<?php
    }
    }
endif;

if (!function_exists('minimal_lite_load_more')):
    /**
     * Ajax Load posts Callback.
     *
     * @since 1.0.0
     *
     */
    function minimal_lite_load_more()
{

        check_ajax_referer('me-load-more-nonce', 'nonce');

        $output['more_post'] = false;
        $output['content'] = array();

        $args['post_type'] = (isset($_GET['post_type']) && !empty($_GET['post_type'])) ? esc_attr($_GET['post_type']) : 'post';
        $args['post_status'] = 'publish';
        $args['paged'] = (int) esc_attr($_GET['page']);

        if (isset($_GET['cat']) && isset($_GET['taxonomy'])) {
            $args['tax_query'] = array(
                array(
                    'taxonomy' => esc_attr($_GET['taxonomy']),
                    'field' => 'slug',
                    'terms' => array(esc_attr($_GET['cat'])),
                ),
            );
        }

        if (isset($_GET['search'])) {
            $args['s'] = esc_attr($_GET['search']);
        }

        if (isset($_GET['author'])) {
            $args['author_name'] = esc_attr($_GET['author']);
        }

        if (isset($_GET['year']) || isset($_GET['month']) || isset($_GET['day'])) {

            $date_arr = array();

            if (!empty($_GET['year'])) {
                $date_arr['year'] = (int) esc_attr($_GET['year']);
            }
            if (!empty($_GET['month'])) {
                $date_arr['month'] = (int) esc_attr($_GET['month']);
            }
            if (!empty($_GET['day'])) {
                $date_arr['day'] = (int) esc_attr($_GET['day']);
            }

            if (!empty($date_arr)) {
                $args['date_query'] = array($date_arr);
            }
        }

        $loop = new WP_Query($args);
        if ($loop->max_num_pages > $args['paged']) {
            $output['more_post'] = true;
        }
        if ($loop->have_posts()):
            while ($loop->have_posts()): $loop->the_post();
                ob_start();
                get_template_part('template-parts/content', get_post_format());
                $output['content'][] = ob_get_clean();
            endwhile;
            wp_reset_postdata();
            wp_send_json_success($output);
        else:
            $output['more_post'] = false;
            wp_send_json_error($output);
        endif;
        wp_die();
    }
endif;
add_action('wp_ajax_minimal_lite_load_more', 'minimal_lite_load_more');
add_action('wp_ajax_nopriv_minimal_lite_load_more', 'minimal_lite_load_more');